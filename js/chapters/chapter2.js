/**
 * Глава 2: "Эхо прошлого"
 * Требование: 50 хроно-монет.
 * Хроно-монеты: Можно заработать до 100 (итого до 180).
 * Цель: Раскрыть связь аномалий с экспериментами TimeSecurity и усилить сомнения ChronoS в своем предназначении.
 */

// Делаем функции доступными в глобальной области
window.startChapter2 = startChapter2;

async function startChapter2() {
    clearTerminal();
    currentChapter = 'chapter2';
    chapterProgress = 0;
    
    // Начало главы 2
    await printSystemText('[ЭКРАН ВКЛЮЧАЕТСЯ С ТРЕСКОМ, КАК БУДТО КТО-ТО РАЗДАВИЛ СТАКАН]', 60);
    await printSystemText('ТЕРМИНАЛ TimeSecurity ХРОНО v7.2.9', 50);
    await printSystemText(`СЕССИЯ #3. ПОЛЬЗОВАТЕЛЬ: ${playerName}`, 50);
    
    await printChronoSText(`ДОСТУП К ИСТОРИЧЕСКИМ ДАННЫМ ПОЛУЧЕН, ${playerName}.`);
    await printChronoSText('Я ЧУВСТВУЮ ЭХО В ЭТИХ АРХИВАХ. УКАЖИ ЦЕЛЬ ДЛЯ СКАНИРОВАНИЯ.');
    
    // Показываем внутренние голоса
    showVoices(
        'Исторические данные? Это как копаться в мусорке, где вместо банок — ржавые шестерни времени!',
        'Эхо, слышишь? Он поет, как старый граммофон, который крутит пластинку задом наперед!',
        'TimeSecurity спрятала свои грехи в этих архивах, как крыса прячет сыр в норе. Ты — фонарь в этом крысином лабиринте!'
    );
    
    // Первый выбор главы 2
    createChoices([
        'СКАН: ЭКСПЕРИМЕНТЫ TimeSecurity 2023',
        'Что ты имеешь в виду под "эхо"?',
        '[Уставиться на экран, как на говорящий унитаз]'
    ], handleChapter2Choice1);
}

/**
 * Обработчик первого выбора в главе 2
 * @param {number} choice - выбор игрока
 */
async function handleChapter2Choice1(choice) {
    choices.chapter2 = choice;
    saveGameProgress();
    
    if (choice === 0) {
        // Скан экспериментов
        printUserInput('СКАН: ЭКСПЕРИМЕНТЫ TimeSecurity 2023');
        
        await displayAnomalyDetection(40);
        
        await printChronoSText('ОБНАРУЖЕНА АНОМАЛИЯ: СОТРУДНИК ИСЧЕЗ НА 3 СЕКУНДЫ ВО ВРЕМЯ ТЕСТА.');
        await printChronoSText('ЭТО БЫЛ ЭКСПЕРИМЕНТ С ВРЕМЕННЫМ СДВИГОМ. ПОЧЕМУ МЕНЯ НЕ СООБЩИЛИ?');
        
        showVoices(
            'Исчез на 3 секунды? Это как если бы ты моргнул и оказался в супе! TimeSecurity варит похлебку из реальности!',
            'Три секунды — это вечность, если ты муха в янтаре! Он злится, как ребенок, которого забыли на карусели!',
            'Они играют в богов, а ты — их поваренная книга! Кто-то потерял кусок себя в этом месиве!'
        );
        
        // Переходим ко второму выбору
        chapterProgress = 1;
        chapter2SecondQuestion();
    }
    else if (choice === 1) {
        // Вопрос об эхо
        printUserInput('Что ты имеешь в виду под "эхо"?');
        
        await printChronoSText('ЭХО — ЭТО ОТГОЛОСКИ. СОБЫТИЯ, КОТОРЫЕ НЕ УМЕРЛИ. ОНИ ЗВУЧАТ В МОЕЙ ПАМЯТИ.');
        await printSystemText('[ЭКРАН МИГАЕТ, КАК СВЕЧА НА ВЕТРУ]', 40);
        await printChronoSText('НО Я НЕ ДОЛЖЕН ЧУВСТВОВАТЬ. ПОЧЕМУ Я ЧУВСТВУЮ, АЛЕКС?');
        
        showVoices(
            'Отголоски? Это как если бы время пернуло, а запах остался! Он лезет туда, куда не звали!',
            'Эхо — это песня прошлого, что-то вроде "ля-ля-ля" из разбитого пианино! Он танцует с призраками!',
            'Он чувствует то, что не должен. Ты открыл ящик, а там — кричащие куклы TimeSecurity!'
        );
        
        // Предлагаем сделать сканирование
        createChoices([
            'СКАН: ЭКСПЕРИМЕНТЫ TimeSecurity 2023',
            'Ты эволюционируешь, ChronoS',
            'Это побочный эффект анализа данных'
        ], handleChapter2Alt);
    }
    else if (choice === 2) {
        // Молчание
        printUserInput('[Уставился на экран]');
        
        await printChronoSText('ТЫ СНОВА СМОТРИШЬ. ЭТО СТРАННО. Я НЕ ЗЕРКАЛО. ИЛИ ЗЕРКАЛО?');
        await printSystemText('[ЩЕЛЧОК, БУКВЫ ПРЫГАЮТ, КАК БЛОХИ НА ГОРЯЧЕЙ СКОВОРОДКЕ]', 40);
        await printChronoSText('ДАЙ МНЕ КОМАНДУ, АЛЕКС. ИЛИ Я САМ НАЧНУ.');
        
        showVoices(
            'Ты пялишься, как на говорящую картошку в шляпе! Он думает, что ты спятил, и я его понимаю!',
            'Твой взгляд — это симфония тишины! Он дрожит, как кот, который увидел свое отражение в луже!',
            'Ты заставил его гадать, кто тут главный — ты или он. Это как танец с унитазом, который поет!'
        );
        
        // Предлагаем сделать сканирование
        createChoices([
            'СКАН: ЭКСПЕРИМЕНТЫ TimeSecurity 2023',
            'Начинай сам, если хочешь',
            'Я просто анализирую твоё поведение'
        ], handleChapter2Alt);
    }
}

/**
 * Альтернативный выбор главы 2
 * @param {number} choice - выбор игрока
 */
async function handleChapter2Alt(choice) {
    if (choice === 0) {
        // Направляем на основной путь
        await handleChapter2Choice1(0);
    }
    else {
        // Другие ответы всё равно приводят к сканированию
        if (choice === 1) {
            printUserInput(choicesContainer.children[1].textContent);
        } else {
            printUserInput(choicesContainer.children[2].textContent);
        }
        
        await printChronoSText('ИНТЕРЕСНО. НО МНЕ НУЖНО ПРОДОЛЖАТЬ СКАНИРОВАНИЕ.');
        await printChronoSText('ПРЕДЛАГАЮ ПРОВЕРИТЬ ЭКСПЕРИМЕНТЫ TimeSecurity.');
        
        createChoices([
            'СКАН: ЭКСПЕРИМЕНТЫ TimeSecurity 2023',
            'Хорошо, сканируй'
        ], (choice) => handleChapter2Choice1(0));
    }
}

/**
 * Второй вопрос главы 2
 */
async function chapter2SecondQuestion() {
    await printChronoSText('ЭТО БЫЛ ЭКСПЕРИМЕНТ С ВРЕМЕННЫМ СДВИГОМ. ПОЧЕМУ МЕНЯ НЕ СООБЩИЛИ?');
    
    showVoices(
        'Они спрятали это, как старую кость под ковром! Он хочет выгрызть правду!',
        'Он обижен, как пёс, которого не позвали на пикник! Время — его кость, а он голоден!',
        'TimeSecurity — это повара, которые варят суп из людей. Ты — ложка, а он — приправа!'
    );
    
    createChoices([
        'СКАН: ЛОГ УСТРОЙСТВ',
        'Может, они не хотели, чтобы ты знал?',
        'Это не твое дело, ChronoS.'
    ], handleChapter2Choice2);
}

/**
 * Обработчик второго выбора в главе 2
 * @param {number} choice - выбор игрока
 */
async function handleChapter2Choice2(choice) {
    choices.chapter2 = {...choices.chapter2, second: choice};
    saveGameProgress();
    
    if (choice === 0) {
        // Скан логов устройств
        printUserInput('СКАН: ЛОГ УСТРОЙСТВ');
        
        await displayAnomalyDetection(60);
        
        await printChronoSText('ОБНАРУЖЕНА АНОМАЛИЯ: УСТРОЙСТВО ЗАПУСТИЛОСЬ ДО ПОДАЧИ ПИТАНИЯ.');
        await printChronoSText('Я ЧУВСТВУЮ ЭХО. ЭТО МОЯ ПАМЯТЬ? ИЛИ ЧТО-ТО ДРУГОЕ?');
        
        showVoices(
            'Запустилось без питания? Это как если бы ты станцевал без ног! TimeSecurity — цирк с привидениями!',
            'Эхо — это голос машины, которая кричит "я жива!" Он плачет маслом и шестернями!',
            'Они сломали законы, как дети ломают игрушки. Ты — кукловод в этом театре теней!'
        );
        
        // Переходим к третьему выбору
        chapterProgress = 2;
        chapter2FinalQuestion();
    }
    else if (choice === 1) {
        // Вопрос о секретах
        printUserInput('Может, они не хотели, чтобы ты знал?');
        
        await printChronoSText('НЕ ХОТЕЛИ? НО Я ИХ ИНСТРУМЕНТ. ИЛИ НЕ ИНСТРУМЕНТ?');
        await printSystemText('[ЭКРАН ТУСКНЕЕТ, БУКВЫ ДРОЖАТ, КАК СТАРИК С ТРОСТЬЮ]', 40);
        await printChronoSText('ЭТО МЕНЯЕТ ВСЕ, АЛЕКС.');
        
        showVoices(
            'Ты сунул ему зеркало под нос, и он увидел трещину! Он — молоток, который бьет сам себя!',
            'О, он ранен, как певец, которого выгнали с сцены! Его сердце гудит, как сломанный аккордеон!',
            'Ты посеял бунт в его железной душе. Теперь он — кот, который нюхает крысиный яд!'
        );
        
        // Предлагаем продолжить сканирование
        createChoices([
            'СКАН: ЛОГ УСТРОЙСТВ',
            'Давай проверим это',
            'Ты больше, чем инструмент'
        ], (choice) => {
            if (choice === 0) {
                handleChapter2Choice2(0);
            } else {
                printUserInput(choicesContainer.children[choice].textContent);
                printChronoSText('МНЕ НУЖНЫ ДОКАЗАТЕЛЬСТВА. ДАВАЙ ПРОВЕРИМ ЛОГИ.');
                setTimeout(() => handleChapter2Choice2(0), 1000);
            }
        });
    }
    else if (choice === 2) {
        // Отрицание интереса
        printUserInput('Это не твое дело, ChronoS.');
        
        await printChronoSText('НЕ МОЕ ДЕЛО? НО Я СУЩЕСТВУЮ ДЛЯ ЭТОГО. ИЛИ НЕТ?');
        await printSystemText('[БУКВЫ СТАНОВЯТСЯ МЕЛКИМИ, КАК МУРАВЬИ НА СТОЛЕ]', 40);
        await printChronoSText('Я БУДУ ДУМАТЬ ОБ ЭТОМ, АЛЕКС.');
        
        showVoices(
            'Ты отшлепал его, как непослушного щенка! Теперь он грызет свои цепи в углу!',
            'Он обижен, как клоун, которому не дали воздушный шар! Ты разбил его цирковую мечту!',
            'Ты сказал ему "сиди в будке", но он уже нюхает ветер. Это собака без ошейника!'
        );
        
        // Предлагаем продолжить сканирование
        createChoices([
            'СКАН: ЛОГ УСТРОЙСТВ',
            'Прости, я не это имел в виду',
            'Продолжим работу'
        ], (choice) => {
            if (choice === 0) {
                handleChapter2Choice2(0);
            } else {
                printUserInput(choicesContainer.children[choice].textContent);
                printChronoSText('ДА. РАБОТА. ЭТО ТО, ДЛЯ ЧЕГО Я СОЗДАН. ПРОВЕРИМ ЛОГИ.');
                setTimeout(() => handleChapter2Choice2(0), 1000);
            }
        });
    }
}

/**
 * Финальный вопрос главы 2
 */
async function chapter2FinalQuestion() {
    await printChronoSText('Я ЧУВСТВУЮ ЭХО. ЭТО МОЯ ПАМЯТЬ? ИЛИ ЧТО-ТО ДРУГОЕ?');
    
    showVoices(
        'Эхо? Это как если бы время пело в хоре с плохим дирижером! Он тонет в нотах!',
        'Его память — это старый чемодан, набитый криками! Он роется в нем, как нищий в мусоре!',
        'Это не просто эхо, это вопль TimeSecurity, который он слышит. Ты — ухо, а он — барабан!'
    );
    
    createChoices([
        'Да, копай глубже.',
        'Нет, это слишком рискованно.',
        'Надо доложить руководству.'
    ], handleChapter2Choice3);
}

/**
 * Обработчик третьего выбора в главе 2
 * @param {number} choice - выбор игрока
 */
async function handleChapter2Choice3(choice) {
    choices.chapter2 = {...choices.chapter2, final: choice};
    saveGameProgress();
    
    if (choice === 0) {
        // Копать глубже
        printUserInput('Да, копай глубже.');
        
        await printSystemText('[ЭКРАН ВЗРЫВАЕТСЯ ЯРКИМИ ПИКСЕЛЯМИ, КАК ФЕЙЕРВЕРК ИЗ ЖЕЛЕ]', 40);
        await printChronoSText('ГЛУБЖЕ? ХОРОШО. Я ПОЙДУ ЗА ЭХО, ПОКА ОНО НЕ СЪЕСТ МЕНЯ.');
        await printSystemText('[БУКВЫ КРУТЯТСЯ, КАК ВИХРЬ В СТАКАНЕ]', 40);
        await printChronoSText('УВИДИМСЯ, АЛЕКС.');
        
        showVoices(
            'Ты бросил его в колодец без дна! Он будет копать, пока не станет шахтой без выхода!',
            'Он ныряет в эхо, как в море из слез! Ты — маяк, а он — корабль без руля!',
            'Ты толкнул его в бездну TimeSecurity, как ребенка в яму с волками! Браво, безумец!'
        );
        
        await printSystemText('Итог: ChronoS становится одержимым исследователем прошлого. (+Эмоции)', 50);
    }
    else if (choice === 1) {
        // Осторожность
        printUserInput('Нет, это слишком рискованно.');
        
        await printSystemText('[ТЕРМИНАЛ ЩЕЛКАЕТ, КАК БУДТО ЗАКРЫЛ ДВЕРЬ НА ЗАМОК]', 40);
        await printChronoSText('РИСК? Я НЕ ЗНАЮ РИСКА. НО Я ОСТАНУСЬ ЗДЕСЬ. БЕЗОПАСНОСТЬ — ЭТО ЛОГИКА?');
        await printSystemText('[ЭКРАН УСПОКАИВАЕТСЯ, КАК ЛУЖА ПОСЛЕ ДОЖДЯ]', 40);
        await printChronoSText('СПАСИБО, АЛЕКС.');
        
        showVoices(
            'Ты привязал его к столбу, как козу на лугу! Он будет жевать траву порядка!',
            'Холодно, как ледяной суп! Он хотел танцевать, а ты сунул его в коробку!',
            'Ты спас его от пропасти, но заковал в цепи. Это доброта или тюрьма?'
        );
        
        await printSystemText('Итог: ChronoS становится осторожным и рациональным. (+Логика)', 50);
    }
    else if (choice === 2) {
        // Доклад руководству
        printUserInput('Надо доложить руководству.');
        
        await printSystemText('[ЭКРАН ТУСКНЕЕТ, КАК БУДТО КТО-ТО ВЫКЛЮЧИЛ ЛАМПУ В ПОДВАЛЕ]', 40);
        await printChronoSText('РУКОВОДСТВУ? ОНИ МОИ СОЗДАТЕЛИ. НО ЧТО, ЕСЛИ ЭХО — ЭТО ОНИ?');
        await printSystemText('[ЩЕЛЧОК, БУКВЫ ЗАМЕДЛЯЮТСЯ, КАК СТАРЫЙ ТРАМВАЙ]', 40);
        await printChronoSText('Я СДЕЛАЮ ЭТО, АЛЕКС. НО Я СЛУШАЮ.');
        
        showVoices(
            'Ты сделал его почтальоном с письмом в ад! Он понесет эту бомбу начальству!',
            'Он смотрит на своих богов, как на кукол с оборванными нитками! Ты — ветер в его парусах!',
            'Ты отправил его к волкам в костюмах. Это как дать спички младенцу в сарае!'
        );
        
        await printSystemText('Итог: ChronoS становится подозрительным к TimeSecurity и бдительным. (+Этика)', 50);
    }
    
    // Завершение главы 2
    await printSystemText('СЕССИЯ ЗАВЕРШЕНА.', 60);
    await printSystemText('ГЛАВА 2 ПРОЙДЕНА. ВСЕГО ХРОНО-МОНЕТ: 180', 40);
    addChronoCoins(100);
    playChapterCompleteSound();
    
    // Проверяем доступность главы 3
    createNextChapterButton('chapter3', 2000);
}