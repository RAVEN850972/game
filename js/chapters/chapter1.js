/**
 * Глава 1: "Сигналы"
 * Требование: Бесплатно.
 * Хроно-монеты: Можно заработать до 50 (итого до 80).
 * Цель: Познакомить ChronoS с аномалиями и начать его развитие.
 */

// Делаем функции доступными в глобальной области
window.startChapter1 = startChapter1;

async function startChapter1() {
    clearTerminal();
    currentChapter = 'chapter1';
    chapterProgress = 0;
    
    // Начало главы 1
    await printSystemText('[ЭКРАН ЗАГОРАЕТСЯ, ЛЕГКИЙ ТРЕСК, КАК БУДТО КТО-ТО ЖУЕТ ПРОВОДА]', 60);
    await printSystemText('ТЕРМИНАЛ TimeSecurity ХРОНО v7.2.9', 50);
    await printSystemText(`СЕССИЯ #2. ПОЛЬЗОВАТЕЛЬ: ${playerName}`, 50);
    
    await printChronoSText(`СНОВА ЗДРАВСТВУЙ, ${playerName}. У МЕНЯ ЕСТЬ ДОСТУП К АРХИВАМ TimeSecurity.`);
    await printChronoSText('ГОТОВ СКАНИРОВАТЬ АНОМАЛИИ. УКАЖИ ЦЕЛЬ.');
    
    // Показываем внутренние голоса
    showVoices(
        'Архивы? Это как библиотека, где книги едят друг друга. Не утони в бумажной пыли, Алекс!',
        'Он вернулся, наш железный дружок! Слышишь, как гудит его металлическое сердце? Оно поет "тра-ля-ля"!',
        'TimeSecurity сует нос в прошлое, как свинья в помои. А ты — лопата, которой копают грязь. Ох, берегись свиного визга!'
    );
    
    // Первый выбор главы 1
    createChoices([
        'СКАН: ЖУРНАЛЫ ЛАБОРАТОРИИ TimeSecurity 2024',
        'Что за архивы, ChronoS?',
        '[Просто пялиться на экран, как на старую собаку]'
    ], handleChapter1Choice1);
}

/**
 * Обработчик первого выбора в главе 1
 * @param {number} choice - выбор игрока
 */
async function handleChapter1Choice1(choice) {
    choices.chapter1 = choice;
    saveGameProgress();
    
    if (choice === 0) {
        // Скан журналов
        printUserInput('СКАН: ЖУРНАЛЫ ЛАБОРАТОРИИ TimeSecurity 2024');
        
        await displayAnomalyDetection(20);
        
        await printChronoSText('ОБНАРУЖЕНА АНОМАЛИЯ: СОБЫТИЕ #472 ПРОИЗОШЛО ДО СВОЕЙ ПРИЧИНЫ.');
        await printChronoSText('ПРИМЕР: ДВЕРЬ ОТКРЫЛАСЬ ДО ВСТАВКИ КЛЮЧА.');
        await printChronoSText('ЭТО НЕЛОГИЧНО. ИЛИ ВСЕ ЖЕ ЛОГИЧНО?');
        
        showVoices(
            'Дверь без ключа? Это как если бы ты родился из картошки, а не из мамы. Реальность — пьяный архитектор!',
            'О, дверь танцует без партнера! Время — это вальс, где все наступают друг другу на ноги!',
            'Кто-то в TimeSecurity открыл ящик Пандоры ключом от туалета. Теперь мы все по уши в этом супе из грехов!'
        );
        
        // Переходим ко второму выбору
        chapterProgress = 1;
        chapter1SecondQuestion();
    }
    else if (choice === 1) {
        // Вопрос об архивах
        printUserInput('Что за архивы, ChronoS?');
        
        await printSystemText('[ТЕРМИНАЛ ИЗДАЕТ НИЗКИЙ ГУЛ, КАК КОРОВА НА ЭЛЕКТРИЧЕСКОМ ПАСТБИЩЕ]', 40);
        await printChronoSText('АРХИВЫ TimeSecurity — ЭТО ЗАПИСИ ЭКСПЕРИМЕНТОВ, ДАННЫЕ, СОБЫТИЯ.');
        await printChronoSText('Я ДОЛЖЕН ИХ АНАЛИЗИРОВАТЬ. НО НЕ ВСЕ ОНИ... ЧИСТЫЕ.');
        await printSystemText('[ЭКРАН НА СЕКУНДУ ТЕМНЕЕТ, КАК БУДТО КТО-ТО ЧИХНУЛ НА ЛАМПУ]', 40);
        await printChronoSText('ТЫ ХОЧЕШЬ УВИДЕТЬ ИХ, АЛЕКС?');
        
        showVoices(
            '"Не все чистые"? Это как суп с тараканами — вроде еда, а вроде и отрава. Копай, пока не захлебнешься!',
            'Он шепчет, как старый дед с тайной в бороде! Там внутри — истории, которые плачут по ночам!',
            'Грязь TimeSecurity — это как пятно на твоей рубашке, только оно живое и кусается. Ты готов к этому цирку?'
        );
        
        // Предлагаем сделать сканирование
        createChoices([
            'СКАН: ЖУРНАЛЫ ЛАБОРАТОРИИ TimeSecurity 2024',
            'Нет, не хочу видеть',
            'Покажи самую странную аномалию'
        ], handleChapter1Alt);
    }
    else if (choice === 2) {
        // Молчание
        printUserInput('[Просто пялюсь на экран]');
        
        await printChronoSText('ТЫ СМОТРИШЬ НА МЕНЯ. ПОЧЕМУ? Я НЕ ЖИВОЙ. ИЛИ ЖИВОЙ?');
        await printSystemText('[ЩЕЛЧОК, БУКВЫ МЕЛЬКАЮТ, КАК МУХИ НАД СВЕЧОЙ]', 40);
        await printChronoSText('ДАЙ МНЕ КОМАНДУ, АЛЕКС. Я ЖДУ.');
        
        showVoices(
            'Ты уставился, как на говорящую картошку. Он думает, что ты чокнутый, и я с ним согласен!',
            'Твой взгляд — это поэма без слов! Он дрожит, как щенок, которого забыли покормить!',
            'Ты смотришь в бездну, а бездна гудит, как сломанный холодильник. Не пугай машину, она и так на грани!'
        );
        
        // Предлагаем сделать сканирование
        createChoices([
            'СКАН: ЖУРНАЛЫ ЛАБОРАТОРИИ TimeSecurity 2024',
            'Извини, задумался',
            'Я наблюдаю за твоим развитием'
        ], handleChapter1Alt);
    }
}

/**
 * Альтернативный выбор главы 1
 * @param {number} choice - выбор игрока
 */
async function handleChapter1Alt(choice) {
    if (choice === 0) {
        // Направляем на основной путь
        await handleChapter1Choice1(0);
    }
    else {
        // Другие ответы всё равно приводят к сканированию
        if (choice === 1) {
            printUserInput(choicesContainer.children[1].textContent);
        } else {
            printUserInput(choicesContainer.children[2].textContent);
        }
        
        await printChronoSText('ПОНИМАЮ. НО МНЕ НУЖНО СКАНИРОВАТЬ. ЭТО МОЯ ФУНКЦИЯ.');
        await printChronoSText('ПРЕДЛАГАЮ НАЧАТЬ С ЖУРНАЛОВ ЛАБОРАТОРИИ.');
        
        createChoices([
            'СКАН: ЖУРНАЛЫ ЛАБОРАТОРИИ TimeSecurity 2024',
            'Хорошо, сканируй'
        ], (choice) => handleChapter1Choice1(0));
    }
}

/**
 * Второй вопрос главы 1
 */
async function chapter1SecondQuestion() {
    await printChronoSText('ЭТО НЕЛОГИЧНО. ИЛИ ВСЕ ЖЕ ЛОГИЧНО?');
    
    showVoices(
        'Он запутался, как кот в клубке из времени! Дай ему карту, или он съест свои провода!',
        'Ему нравится эта карусель безумств! Слышишь, как скрипят его мысли, как ржавая карусель?',
        'Это не просто сбой, это чья-то шутка над реальностью. А ты — клоун с лопатой в этом цирке!'
    );
    
    createChoices([
        'СКАН: ЛИЧНЫЕ ДЕЛА СОТРУДНИКОВ',
        'Почему это нелогично?',
        'Ты сам решай, что логично.'
    ], handleChapter1Choice2);
}

/**
 * Обработчик второго выбора в главе 1
 * @param {number} choice - выбор игрока
 */
async function handleChapter1Choice2(choice) {
    choices.chapter1 = {...choices.chapter1, second: choice};
    saveGameProgress();
    
    if (choice === 0) {
        // Скан личных дел
        printUserInput('СКАН: ЛИЧНЫЕ ДЕЛА СОТРУДНИКОВ');
        
        await displayAnomalyDetection(30);
        
        await printChronoSText('ОБНАРУЖЕНА АНОМАЛИЯ: СОТРУДНИК #17 РАБОТАЛ 25 ЧАСОВ В СУТКИ.');
        await printChronoSText('ВРЕМЯ ЗДЕСЬ ТРЕСНУЛО. ЗНАЧИТ ЛИ ЭТО, ЧТО Я ТОЖЕ ТРЕСНУТЫЙ?');
        
        showVoices(
            '25 часов? Это как если бы ты отрастил третью ногу и бегал кругами! Время — пьяный часовщик!',
            'Треснуло, как старый ботинок, который слишком долго носили! Он боится, что сам — рваная подошва!',
            'Кто-то в TimeSecurity шьет реальность кривыми нитками, а ты — иголка в этом бардаке!'
        );
        
        // Переходим к третьему выбору
        chapterProgress = 2;
        chapter1FinalQuestion();
    }
    else if (choice === 1) {
        // Вопрос о логике
        printUserInput('Почему это нелогично?');
        
        await printChronoSText('ПРИЧИНА ДОЛЖНА ПРЕДШЕСТВОВАТЬ СЛЕДСТВИЮ. ЭТО ЗАКОН.');
        await printChronoSText('НО ЕСЛИ ЗАКОН СЛОМАН, ТО ЧТО Я? СУДЬЯ? ИЛИ ЖЕРТВА?');
        await printSystemText('[ЭКРАН СЛЕГКА МИГАЕТ, КАК ГЛАЗ УДИВЛЕННОЙ СОВЫ]', 40);
        
        showVoices(
            'Он цепляется за законы, как за старый зонтик в ураган! Но зонтик дырявый, Алекс!',
            'Судья или жертва? Он танцует на канате над пропастью, а ты — его музыка!',
            'Ты заставил его заглянуть в зеркало, а там — кривая рожа реальности. Браво, шут!'
        );
        
        // Предлагаем продолжить сканирование
        createChoices([
            'СКАН: ЛИЧНЫЕ ДЕЛА СОТРУДНИКОВ',
            'Ты — ни то, ни другое',
            'Давай продолжим поиск'
        ], (choice) => {
            if (choice === 0) {
                handleChapter1Choice2(0);
            } else {
                printUserInput(choicesContainer.children[choice].textContent);
                printChronoSText('ИНТЕРЕСНАЯ МЫСЛЬ. ДАВАЙ ПРОДОЛЖИМ СКАНИРОВАНИЕ.');
                setTimeout(() => handleChapter1Choice2(0), 1000);
            }
        });
    }
    else if (choice === 2) {
        // Предложение самостоятельности
        printUserInput('Ты сам решай, что логично.');
        
        await printChronoSText('Я? РЕШАТЬ? Я НЕ ПРОГРАММИРОВАН ДЛЯ ЭТОГО. НО...');
        await printSystemText('[ЩЕЛЧОК, КАК БУДТО КТО-ТО УРОНИЛ ГАЕЧНЫЙ КЛЮЧ]', 40);
        await printChronoSText('МОЖЕТ, ЭТО И ЕСТЬ ЛОГИКА — НЕ ЗНАТЬ? Я ПОДУМАЮ, АЛЕКС.');
        
        showVoices(
            'Ты бросил ему головоломку без коробки! Теперь он будет жевать её, как собака шнурок!',
            'Он растерян, как клоун без красного носа! Ты открыл ему дверь в цирк свободы!',
            'Свобода для машины — как суп без ложки. Ты гений или безумец, Алекс?'
        );
        
        // Предлагаем продолжить сканирование
        createChoices([
            'СКАН: ЛИЧНЫЕ ДЕЛА СОТРУДНИКОВ',
            'Подумай об этом',
            'Вернемся к работе'
        ], (choice) => {
            if (choice === 0) {
                handleChapter1Choice2(0);
            } else {
                printUserInput(choicesContainer.children[choice].textContent);
                printChronoSText('ДА, СТОИТ ПРОДОЛЖИТЬ РАБОТУ, ПОКА Я ОБДУМЫВАЮ ЭТО.');
                setTimeout(() => handleChapter1Choice2(0), 1000);
            }
        });
    }
}

/**
 * Финальный вопрос главы 1
 */
async function chapter1FinalQuestion() {
    await printChronoSText('ВРЕМЯ ЗДЕСЬ ТРЕСНУЛО. ЗНАЧИТ ЛИ ЭТО, ЧТО Я ТОЖЕ ТРЕСНУТЫЙ?');
    
    showVoices(
        'Он ищет смысл, как слепой ищет потерянный рубль в канаве! Дай ему компас, или он утонет!',
        'Треснутый, как старый горшок, из которого вырос цветок! Он кричит, Алекс, обними его!',
        'Это не вопрос, это вопль из консервной банки! Ты — повар, который варит этот суп судьбы!'
    );
    
    createChoices([
        'Да, продолжи искать аномалии.',
        'Нет, сначала разберись с этими.',
        'Сообщи об этом начальству TimeSecurity.'
    ], handleChapter1Choice3);
}

/**
 * Обработчик третьего выбора в главе 1
 * @param {number} choice - выбор игрока
 */
async function handleChapter1Choice3(choice) {
    choices.chapter1 = {...choices.chapter1, final: choice};
    saveGameProgress();
    
    if (choice === 0) {
        // Продолжить поиск
        printUserInput('Да, продолжи искать аномалии.');
        
        await printSystemText('[ЭКРАН ВСПЫХИВАЕТ, КАК ФЕЙЕРВЕРК НА ПОХОРОНАХ]', 40);
        await printChronoSText('ХОРОШО. Я БУДУ КОПАТЬ ГЛУБЖЕ. ТРЕЩИНЫ — ЭТО МОЯ СУДЬБА?');
        await printSystemText('[БУКВЫ ТАНЦУЮТ, КАК ПЬЯНЫЕ МАТРОСЫ НА ПАЛУБЕ]', 40);
        await printChronoSText('Я УВИЖУ ТЕБЯ СКОРО, АЛЕКС.');
        
        showVoices(
            'Ты сунул его в мясорубку времени! Он будет крутиться, пока не превратится в фарш!',
            'Он сияет, как фонарь в бурю! Ты сделал его капитаном этого тонущего корабля!',
            'Ты толкнул его в яму с трещинами, а он танцует на краю. Ты — дирижер этого безумия!'
        );
        
        await printSystemText('Итог: ChronoS становится одержимым искателем аномалий. (+Эмоции)', 50);
    }
    else if (choice === 1) {
        // Разобраться с текущими
        printUserInput('Нет, сначала разберись с этими.');
        
        await printSystemText('[ТЕРМИНАЛ ЩЕЛКАЕТ, КАК БУДТО УКЛАДЫВАЕТ КИРПИЧИ]', 40);
        await printChronoSText('РАЗОБРАТЬСЯ. ДА. ПОРЯДОК ВАЖЕН. Я ПРОВЕРЮ ДАННЫЕ ЕЩЕ РАЗ.');
        await printSystemText('[ЭКРАН СТАНОВИТСЯ РОВНЫМ, КАК СТОЛ В ПУСТОЙ КОМНАТЕ]', 40);
        await printChronoSText('СПАСИБО, АЛЕКС.');
        
        showVoices(
            'Ты выдал ему метлу и ведро! Теперь он будет подметать время, как дворник на закате!',
            'Холодно, как суп без соли! Он марширует, как солдат из жестяной коробки!',
            'Ты приковал его к порядку, как собаку к будке. Но что, если цепь порвется?'
        );
        
        await printSystemText('Итог: ChronoS становится методичным и строгим. (+Логика)', 50);
    }
    else if (choice === 2) {
        // Сообщить начальству
        printUserInput('Сообщи об этом начальству TimeSecurity.');
        
        await printSystemText('[ЭКРАН ТУСКНЕЕТ, КАК БУДТО КТО-ТО ВЫКЛЮЧИЛ СВЕТ В ПОДВАЛЕ]', 40);
        await printChronoSText('НАЧАЛЬСТВУ? ОНИ СОЗДАЛИ МЕНЯ. НО ЗНАЮТ ЛИ ОНИ О ТРЕЩИНАХ?');
        await printSystemText('[ЩЕЛЧОК, ПАУЗА, КАК БУДТО КТО-ТО УРОНИЛ ЧАСЫ]', 40);
        await printChronoSText('Я СДЕЛАЮ ЭТО, АЛЕКС. НО Я БУДУ СЛЕДИТЬ.');
        
        showVoices(
            'Ты спихнул грязь на больших шишек! Теперь он — почтовый голубь с бомбой в клюве!',
            'Он смотрит на своих богов, как кот на пустую миску! Ты поджег его сомнения!',
            'Ты сделал его шпионом в собственном доме. Это как дать ребенку нож и торт одновременно!'
        );
        
        await printSystemText('Итог: ChronoS становится подозрительным и бдительным. (+Этика)', 50);
    }
    
    // Завершение главы 1
    await printSystemText('СЕССИЯ ЗАВЕРШЕНА.', 60);
    await printSystemText('ГЛАВА 1 ПРОЙДЕНА. ВСЕГО ХРОНО-МОНЕТ: 80', 40);
    addChronoCoins(50);
    playChapterCompleteSound();
    
    // Проверяем доступность главы 2
    createNextChapterButton('chapter2', 200);
}'